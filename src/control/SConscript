#!/bin/env python
"""Build DAOS Control Plane"""
#pylint: disable=too-many-locals
import os
from os.path import join, isdir

def check_dir_exists(path):
    """
    Check if path points to an existing directory. If it is a file but not a
    directory, delete it.
    """
    if not isdir(path):
        # Not a directory - clear out any file
        if os.path.exists(path):
            os.unlink(path)
        return False
    return True

def do_build(env, path, gosrc, cmd):
    """execute a build command"""
    # Link the version-controlled DAOS Go source directory src/control into
    # GOPATH/src/REPOPATH/src/control in the build directory.
    if not check_dir_exists(path):
        os.makedirs(path)
    path = join(path, "control")
    if not check_dir_exists(path):
        os.symlink(gosrc, path)
    return env.Execute(cmd)

def cmd_build(gopath, repopath, cmd):
    """create a command that ensure paths exist before execution"""
    return lambda target, source, env: do_build(env, gopath, repopath, cmd)

def get_install_src_dir(repopath, name):
    """Get the Gopath-based directory to run 'go install' on"""
    return join(repopath, "src", "control", name)

def get_install_bin_path(env, name):
    """Get the final installation location for a binary with a given name"""
    return join(env.subst("$PREFIX"), "bin", name)

def get_bin_path(gopath, name):
    """Get the default location of the binary generated by go build"""
    return join(gopath, "bin", name)

def show_go_info():
    from distutils import spawn
    go_bin = spawn.find_executable("go")
    go_version = os.popen('%s version' % go_bin).read()
    print("Go compiler installed at %s: %s" % (go_bin, go_version)),

#pylint: disable=too-many-arguments
def install_go_bin(denv, gosrc, gopath, libs, name, install_name):
    """
    Build a Go binary whose source is under directory 'name' and install it
    as 'install_name'.
    libs should be a list of scons-built libraries, or None if none are needed.
    """
    # Repository path shared by DAOS Go package import paths
    repopath = join("github.com", "daos-stack", "daos")
    # Go path to DAOS code
    path = join(gopath, "src", repopath, "src")

    bin_path = get_bin_path(gopath, name)
    mod_src = join(gosrc, name, "main.go") # Module src
    install_src = get_install_src_dir(repopath, name)
    install_bin = get_install_bin_path(denv, install_name)
    src = [mod_src]
    if libs is not None:
        src.extend(libs)
    denv.Command(bin_path, src,
                 cmd_build(path, gosrc,
                           "go install %s" % install_src))
    denv.InstallAs(install_bin, bin_path)
#pylint: enable=too-many-arguments

def scons():
    """Execute build"""
    Import('env', 'prereqs')

    env.AppendUnique(LIBPATH=[Dir('.')])

    denv = env.Clone()
    prereqs.require(denv, 'spdk')

    # if SPDK_PREFIX differs from PREFIX, copy dir so files can be accessed at
    # runtime
    if denv.subst("$SPDK_PREFIX") != "/usr":
        if denv.subst("$SPDK_PREFIX") != denv.subst("$PREFIX"):
            for subdir in ["scripts", "fio_plugin"]:
                sharedir = join("share", "spdk", subdir)
                tpath = join(denv.subst("$PREFIX"), sharedir)
                if not check_dir_exists(tpath):
                    denv.Command(
                        tpath,
                        join(denv.subst("$SPDK_PREFIX"), sharedir),
                        Copy("$TARGET", "$SOURCE"))
        tpath = join(denv.subst("$PREFIX"), "include")
        if not check_dir_exists(tpath):
            denv.Command(
                tpath,
                join(denv.subst("$SPDK_PREFIX"), "include"),
                Copy("$TARGET", "$SOURCE"))

    show_go_info()

    # GOPATH for SCons builds in the build directory
    gopath = Dir('.').abspath
    # Version-controlled DAOS Go source directory src/control
    gosrc = Dir('.').srcnode().abspath

    denv.Append(GOPATH=[gopath])
    denv.AppendENVPath('GOPATH', denv['GOPATH'])
    denv['ENV']['GOBIN'] = join(gopath, "bin")
    denv['ENV']['PKG_CONFIG_PATH'] = denv.subst('$PREFIX/lib/pkgconfig')

    install_go_bin(denv, gosrc, gopath, None, "agent", "daos_agent")

    gospdkpath = join(gosrc, "vendor", "github.com", "daos-stack", "go-spdk",
                      "spdk")

    # hack to avoid building this library with cov compiler for the moment
    compiler = denv.get('COMPILER').lower()
    if compiler == "covc":
        compiler = "gcc"

    nvmecontrol = denv.StaticLibrary(
        "nvme_control",
        join(gospdkpath, "src", "nvme_control.c"),
        CC=compiler, LIBS=['spdk'])

    # short-term hack to generate spdk.pc until the project generates it
    spdk_version_src = """
#include <stdio.h>
#include <spdk/version.h>
int main(int argc, char **argv)
{
    printf("%d.%d.%d", SPDK_VERSION_MAJOR, SPDK_VERSION_MINOR, SPDK_VERSION_PATCH);
    return 0;
}
"""
    def CheckSPDKVersion(context):
        context.Message('Checking SPDK version... ')
        result = context.TryRun(spdk_version_src, '.c')
        if result[0]:
              context.env.Append(SPDK_VERSION = result[1])
        context.Result(result[1])
        return result[1]

    conf = Configure(denv, custom_tests={'CheckSPDKVersion': CheckSPDKVersion})
    if not conf.CheckSPDKVersion():
        print 'Can\'t check SPDK version'
        Exit(1)
    denv = conf.Finish()
    
    denv.Substfile('spdk.pc.in', SUBST_DICT={'\@PREFIX\@': env.get('PREFIX'), '\@VERSION\@': denv.get('SPDK_VERSION')})
    denv.Install('$PREFIX/lib/pkgconfig', ['spdk.pc', 'spdk.pc'])
    denv.Depends(env.subst('$PREFIX/lib/pkgconfig/spdk.pc'), 'spdk.pc')
    denv.Depends(nvmecontrol, denv.subst('$PREFIX/lib/pkgconfig/spdk.pc'))

    denv.Install(join(denv.subst("$PREFIX"), "lib"), nvmecontrol)

    # copy server init files to be used at runtime, explicitly
    # remove first because recursive Delete() on dir fails.
    moduleserver = join(gosrc, "server")
    for fname in ["mgmtinit_db.json", "setup_spdk.sh"]:
        denv.Command(
            join("$PREFIX", "share", "daos", "control", fname),
            join(moduleserver, "init", fname),
            [
                Delete("$TARGET"),
                Copy("$TARGET", "$SOURCE")
            ])

    install_go_bin(denv, gosrc, gopath, [nvmecontrol], "server", "daos_server")
    install_go_bin(denv, gosrc, gopath, None, "dmg", "daos_shell")
    install_go_bin(denv, gosrc, gopath, None, "drpc_test", "hello_drpc")

    agentbin = get_bin_path(gopath, "agent")
    denv.Depends(agentbin, env.subst('$PREFIX/lib/pkgconfig/libdaos.pc'))
    serverbin = get_bin_path(gopath, "server")
    denv.Depends(agentbin, env.subst('$PREFIX/lib/pkgconfig/libdaos.pc'))
    shellbin = get_bin_path(gopath, "dmg")
    drpcbin = get_bin_path(gopath, "drpc_test")
    AlwaysBuild([agentbin, serverbin, shellbin, drpcbin])

if __name__ == "SCons.Script":
    scons()
