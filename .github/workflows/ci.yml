name: Workflow
# This workflow is triggered on pushes to the repository.
on: [push]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro: [centos.7, leap.15, ubuntu.20.04]
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: true
    - name: Build in Docker Image
      env:
        DOCKER_IMAGE: ${{ github.repository }}:${{ github.sha }}
      run: |
        docker build -f utils/docker/Dockerfile.${{ matrix.distro }} -t daos/$DOCKER_IMAGE --build-arg NOBUILD=1 --build-arg UID=$UID . &&
        docker run -v $PWD:/home/daos/daos:z daos/$DOCKER_IMAGE /bin/bash -c "scons --build-deps=yes -j 4 install BUILD_TYPE=dev" &&
        docker run -v $PWD:/home/daos/daos:z daos/$DOCKER_IMAGE /bin/bash -c "cd src/client/java && mvn clean install -T 1C -DskipITs -Ddaos.install.path=/home/daos/daos/install" ||
        (echo -e "\e[31m[${GITHUB_WORKFLOW}] failed to build\e[m" && exit 1)
